Инженерные практики в отдельно взятой команде
=============================================

## (Слайды)[http://niquola.github.io/spb-agile-kitchen-2014-april-slides/]

### Кто мы?

Мы небольшая команда профессионалов, которая
уже 6 лет разрабатывает и поддерживает медицинскую
информационную систему для США.

### О чем?

Я расскажу о некоторых инженерных практиках,
которые прижились в нашей команде.

* Исследования (Spike)
* Прототипирование
* Архитектурные обсуждения
* Десяти пальцевая слепая печать и другие автоматизмы и преднамеренные практики
* Разработка движимая тестами
* Перепроектирование и рефакторинг
* Staging & Deploy
* Devops & Cloud

### Зачем?

Первая причина - чтобы показать, что мы крутые,
и чтобы вы знали у кого спросить! Мы всегда готовы
поделиться опытом.

Вторая - возможно вы не про все практики знали -
теперь узнаете и задумаетесь. Может быть они позволят решить
некоторые из ваших текущих проблем.

Третья - бывает так что вы знаете, но не применяете.
Тогда я достигну цели если мотивирую вас к действию.

4-5 лет назад мы пытались внедрять TDD в нашем проекте.
Провели несколько семинаров и даже написали ряд тестов.
Но все еще были по ту сторону! И я отчетливо помню,
что на одном из митапов мы прослушали доклад про тестирование.
В нем не было ничего нового с точки зрения информации и он не был блестящим,
но он стал последней каплей с точки зрения мотивации. Мы пришли на работу
и решили, что без тестов больше не пишем. Теперь это физиологическая потребность :)

Для искушенных в докладе будут некоторые уникальные практики!

###  Исследования

Когда перед нами встает задача,
зачастую мы не знаем выполнима она или нет,
не можем оценить сложность и сроки,
вынуждены выбрать из альтернатив.

Как быть?

Можно не думать об этом и ориентироваться интуитивно:
сказать что "конечно сделаем", за некий средний срок,
выбрав наугад или по косвенным признакам.

Но можно эту неопределенность сделать явной.
У нас в команде есть такой тип задачи - "исследование".
Чаще мы его называем english agile термином - spike.

Такие задачи ограничиваются по времени (таймбоксятся - например 1 день),
и их результатом является отчет и/или командное обсуждение.

Важно, что этот концепт явный и имеет название.
И он проявляется следующим образом:

> "А мы можем это сделать и за сколько?"
> "Завтра сделаем спайк и скажем"

> "Есть ощущение, что не все так просто как казалось - нужно сделать спайк"

В общем это как разведка в боевых действиях.

### Прототипы

Кто регулярно пользуется прототипами?

Если неопределенность не снять силами разработчиков (и требуется попробовать или дать потрогать),
мы используем другой инструмент - прототипирование. Основная задача прототипа
за минимальные сроки и с минимальными усилиями снять эту неопределенность.
Например как можно быстрее замкнуть обратную связь от стэйкхолдеров или пользователей,
чтобы не наделать лишнего или вам потом сказали "ЭТО СОВСЕМ НЕ ТО".

Мы встроили прототипы в систему - прототипы разрабатываются и выкатываюся вместе со всей системой.
Где определенная фокус группа врачей имеет к ним доступ и может дать обратную связь.
Они оказались настолько эффективными, что почти все серьезные фичи мы вначале реализуем и быстро
доставляем, как прототипы. Часто прототипирование занимает несколько итераций - но это чудесно!
Это дешево и позволяет нам не делать лишней работы.
Количество итераций на прототипах - это хорошая метрика для определения их необходимости!

### Обсуждения и архитектурные сессии

Результаты спайков и прототипов часто выносятся на командные обсуждения.

Кто систематически проводит такие обсуждения?

Мы их делаем всегда когда задача превышает некоторый уровень сложности.
Тут тоже важно, чтобы архитектурные сессии были явными и систематичными.

Есть много техник - брейн-штормы, доклады или демонстрации с обсуждением.
Можно их явно фасилитировать.

Например для выбора из альтернатив мы часто используем табличку плюсов/минусов:

Для каждой альтернативы создается колоночка, и вы начинаете добавлять критерии
в новых строчках, расставляя плюсы минусы и вопросы на пересечениях. Подобная
визуализация оказывается очень полезной при принятии решения и позволяет
не упустить важных деталей. Часто расписав плюсы/минусы решение становиться очевидным.

### Парное программирование

Мы практикуем парное программирование на полное рабочее время. О парном программировании
есть запись моего доклада на Agile Days, поэтому скажу лишь выжимку:

Парное программирование существенно повышает качество инженерных решений, дает
вам истинное общее владение кодом, и что я считаю важным - сильно снижает уровень
стресса в команде.

Если интересен наш опыт обращайтесь за советом.

### Автоматизмы

Кто владеет слепым десятипальцевым методом печати?
Кто ставил себе руку на тренажере?

Это может показаться незначительной технической деталью.
Но особенно работая в паре понимаешь насколько подобные автоматизмы
важны для эффективной работы. У человека не владеющего слепой печатью
устает шея, ему необходимы постоянные микропрерывания, чтобы выполнять
механические действия в это время он робот и его нет рядом с тобой.
Вследствие этого человек рвет ритм работы, быстрее утомляется и тд и тп.
А цена того чтобы вы больше никогда не задумывались об этом - месяц упражнений на клавиатурном
тренажере по пол часа в день.

Когда к нам приходит новый разработчик, который не владеет слепой печатью - он автоматом
получает месяц тренажера.

Когда вы разлочили у себы эту абилити - у вас открывается следующий уровень - освоение IDE.
Вы со скоростью нервного импульса можете навигировать по проекту, прогонять тесты и рефакторить код!

Мы зачастую недооцениваем то, насколько сложные действия могут быть превращены в автоматизмы
и больше не отвлекать наше ограниченное внимание на глупые действия. Научные исследования
показывают что наше сознание очень ограниченно!

Вспомните как вы открываете входную дверь продолжая говорить по телефону и даже не можете вспомнить,
как оказались в квартире. А посмотрите на музыкантов и спортсменов.

## Рабочее окружение

Вы должны быть в хорошем смысле слова "нетерпимы" ко всему, что отвлекает вас от
предметной деятельности. Тесты должны гонятся сами и быстро. Инструменты для рутиных
задач должны быть написаны и быть всегда под рукой.

## Test Drive Development

Кто пишет автоматические тесты?
Кто не может не писать тесты?

Зачем вы их пишете?
Когда вы их пишете?

TDD это не просто код тестирующий код для отлова ошибок,
это профессиональная культура разработки (как гигиена),

* итеративность (red-green-refactor)
* проектирование (эксперимент)
* песочница (удобство разработки и отладки)
* контроль над кодом (страх)

Это обязательный инструмент для тех кто хочет себя
считать инженером. Приверженность TDD выяснить легко,
когда человека помещают в среду в которой пока еще автоматическое
тестирование широко не распространено.

Например, через пол года после внедрения devops мы поймали
себя на мысли, что боимся трогать инфраструктурный код.
Внесение правок и расширение стало вызывать неприятное ощущение.
Тогда мы остановились и написали [foodtaster](https://github.com/foodtaster)
- библиотеку для тестирования инфраструктурного кода с использованием визуализации (vagrant).

Уже когда мы начали делать медицинскую базу данных с использованием СУБД postgresql,
первым вопросом разработчиков - есть ли тестовый фрэймворк для postgres. И мы нашли
pg_tap. Поэтому я могу утверждать, что дух TDD поселился в нашей команде. Но это долгий путь
и он пролегает в голове.

Есть продвинутые подходы в современном тестировании - генеративное и мутационное тестирование.

Другой показатель истинного TDD: Я убедился, что разработчики не способны писать приемочные тесты!
Хорошо их могут писать лишь тестировщики - поскольку они действительно кровно заинтересованы в подобном
помощнике. Разработчику чужда вся комбинаторика, родная тестировщику. Достаточно сравнить их тесты.

### Перепроектирование и рефакторинг

Один из самых лютых врагов программиста это сложность!
Мы разрабатываем систему, мы ей управляем.
Достигая некоторого порога сложности система начинает управлять нами.
Мы начинаем толкать слона. Поэтому важно постоянно рефакторить и перепроектировать
систему.

Для этого не надо останавливать разработку. Вы можете это делать постепенно.
Например переход с frontend фреймворка dojo на angularjs и замена рукописного css на twitter bootstrap
у нас заняла около года. Инструмент за инструментом мы переписывали и деплоили.

Поэтому как только видите, что можно сделать проще (правильней) - сразу делайте,
иначе момент можно упустить и дело рук ваших погребет вас под своим весом.

### Deploy & Staging

Есть сложные и ответственные операции - например deploy.
Человеку свойственно ошибаться - особенно в стрессовой ситуации.
Те кто это испытал - поймут.

Хорошие программисты учатся правильно распределять ответственность между модулями
системы. Сложность и ответственность можно разделить! В случае с деплоем
это можно сделать создав тестовую область - staging, которая как можно более точно
воспроизводит продакшн.

Причем чем сложнее создать эту область - тем оправданней.

В нашей системе staging является неотъемлемой частью инсталляции.
Одним нажатием кнопки staging можно привести в состояние практически идентичное продакшену.
Мы можем неограниченное количество раз репетировать деплой и основные проблемы решать в песочнице.
Деплой на продакшн у нас делает тестировщица при легком сопровождении так называемых офицеров деплоя -
пары программистов, которые доступны в случае возможных проблем. Мы деплоим и идем на внутренний семинар,
а когда-то не спали ночами.

### Cloud

Если хочешь быть счастливым - будь им.
Если хочешь комфортно работать - устраняй дискомфорт.

Пример: у нас медицинское приложение - мы его хостили
в выделенном дата-центре на своих серверах. И с ними постоянно
возникали проблемы - горели винты, надо было добавлять новые,
ленивые и не очень умные американские админы. Я собственно ручно
где-то в трущобах Лос-Анджелеса запихивал в стойку, не влезающий туда
новый сервак, а один из инвесторов держал стремянку :)

Промучившись так пару лет наше терпение лопнуло и мы поставили цель - переехать в облако.

Это было не простое решение, с жирных dellовских серверов переехать
на дохленькие облачные машинки. Переезд повлек перепроектирование
системы - нам пришлось избавиться от использования в системе дисковых хранилишь,
чтобы вместо одного мощного application сервера мы могли поднять троечку на разных машинах.

Зато теперь мы забыли, что такое дефицит железа, рассыпавшиеся рейды и сгоревшие винты.
А затраты на amazon меньше, чем зарплата американского админа.
Также облако открыло нам возможность автоматизировать процесс разворачивания новой инсталляции,
приватное облако со stagingом, vpnом и реплицирующимеся базами разворачивается автоматически
за пол часа.

## Образование

Мы не знаем того чего не знаем. Возможно проблемы с которыми мы боремся
уже кем-то решены. Поэтому важно встроить обучение в рабочий процесс.

## Summary

Внимательно всматриваясь в используемые практики
меня не покидает ощущение, что они все об одном.

Есть две фундаментальные проблемы:

* Ограниченность человека (ресурсов)
* Неопределенность

Ограниченность - разделение труда и сериализация
Неопределенность - итеративность

### Как это применить?
